const express = require('express');
const axios = require('axios');
require('dotenv').config();

const app = express();
// Render рдХреЛ рд▓рд╛рдЧрд┐ рдкреЛрд░реНрдЯ резрежрежрежреж рд╕реЗрдЯ рдЧрд░рд┐рдПрдХреЛ рдЫ
const PORT = process.env.PORT || 10000; 

// рез. Render рдмрд╛рдЯ 'Dynamic' рдореЛрдбрд▓ рд░ рд╕рд╛рдБрдЪреЛ рддрд╛рдиреНрдиреЗ
const GROQ_API_KEY = process.env.GROQ_API_KEY || "";
const GROQ_MODEL = process.env.GROQ_MODEL || "llama-3.1-70b-versatile"; 

// реи. рд╕реНрдЯреНрдпрд╛рдЯрд┐рдХ рдмреНрдпрд╛рдХрдЕрдк рдбрд╛рдЯрд╛ (рддрдкрд╛рдИрдБрдХреЛ рдпреЛрдЬрдирд╛ рдЕрдиреБрд╕рд╛рд░)
// рдПрдЖрдИ рдлреЗрд▓ рднрдпреЛ рднрдиреЗ рдпреЛ рдбрд╛рдЯрд╛ рд╕рд┐рдзреИ рдЬрд╛рдиреНрдЫ, рдЬрд╕рд▓реЗ рдЧрд░реНрджрд╛ рдПрдкрдорд╛ рдПрд░рд░ рдЖрдЙрдБрджреИрдиред
const backupRasifal = [
    {"sign":"рдореЗрд╖","prediction":"рдЖрдЬ рдирдпрд╛рдБ рдХрд╛рдордХреЛ рдерд╛рд▓рдиреА рдЧрд░реНрдиреЗ рд░рд╛рдореНрд░реЛ рд╕рдордп рдЫред рдЖрддреНрдорд╡рд┐рд╢реНрд╡рд╛рд╕ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рд╡реГрд╖","prediction":"рдзрди рд░ рдкрд░рд┐рд╡рд╛рд░рдХреЛ рдХреНрд╖реЗрддреНрд░рдорд╛ рд▓рд╛рдн рдорд┐рд▓реНрдиреЗрдЫред рдмреЛрд▓реАрдорд╛ рдорд┐рдард╛рд╕ рд▓реНрдпрд╛рдЙрдиреБрд╣реЛрд▓рд╛ред"},
    {"sign":"рдорд┐рдереБрди","prediction":"рд▓рд╛рдореЛ рд╕рдордпрджреЗрдЦрд┐ рд░реЛрдХрд┐рдПрдХрд╛ рдХрд╛рдорд╣рд░реВ рдмрдиреНрдиреЗрдЫрдиреНред рд╕рд╛рдереАрдХреЛ рд╕рд╣рдпреЛрдЧ рдорд┐рд▓реНрдиреЗрдЫред"},
    {"sign":"рдХрд░реНрдХрдЯ","prediction":"рд╕реНрд╡рд╛рд╕реНрдереНрдпрдорд╛ рдЕрд▓рд┐ рдмрдвреА рдзреНрдпрд╛рди рджрд┐рдиреБрд╣реЛрд▓рд╛ред рдЕрдирд╛рд╡рд╢реНрдпрдХ рдЦрд░реНрдЪ рдмрдвреНрди рд╕рдХреНрдЫред"},
    {"sign":"рд╕рд┐рдВрд╣","prediction":"рдорд╛рди-рд╕рдореНрдорд╛рди рд░ рдкреНрд░рддрд┐рд╖реНрдард╛рдорд╛ рд╡реГрджреНрдзрд┐ рд╣реБрдиреЗрдЫред рд╕рд╛рдорд╛рдЬрд┐рдХ рдХрд╛рдордорд╛ рд░реБрдЪрд┐ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рдХрдиреНрдпрд╛","prediction":"рдЕрдзреНрдпрдпрди рдЕрдзреНрдпрд╛рдкрдирдорд╛ рд╕рдлрд▓рддрд╛ рдорд┐рд▓реНрдиреЗрдЫред рд╡реИрджреЗрд╢рд┐рдХ рдХрд╛рд░реНрдп рдЕрдШрд┐ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рддреБрд▓рд╛","prediction":"рдЖрд░реНрдерд┐рдХ рд▓рд╛рднрдХреЛ рдпреЛрдЧ рдЫред рдирдпрд╛рдБ рд╕рдореНрдмрдиреНрдзрд╣рд░реВ рд╕реБрдордзреБрд░ рд╣реБрдиреЗрдЫрдиреНред"},
    {"sign":"рд╡реГрд╢реНрдЪрд┐рдХ","prediction":"рдХрд╛рдордорд╛ рдврд┐рд▓рд╛рд╕реБрд╕реНрддреА рд╣реБрди рд╕рдХреНрдЫ, рдзреИрд░реНрдп рд░рд╛рдЦреНрдиреБрд╣реЛрд▓рд╛ред рд╢рддреНрд░реБ рдкрд░рд╛рд╕реНрдд рд╣реБрдиреЗрдЫрдиреНред"},
    {"sign":"рдзрдиреБ","prediction":"рдпрд╛рддреНрд░рд╛рдХреЛ рдпреЛрдЬрдирд╛ рдмрдиреНрдиреЗрдЫред рдзрд╛рд░реНрдорд┐рдХ рдХрд╛рд░реНрдпрдорд╛ рдорди рдЬрд╛рдиреЗрдЫред"},
    {"sign":"рдордХрд░","prediction":"рд░реЛрдХрд┐рдПрдХрд╛ рдкреБрд░рд╛рдирд╛ рдХрд╛рдорд╣рд░реВ рд╕реБрд▓реНрдЭрд┐рдиреЗрдЫрдиреНред рдШрд░рдорд╛ рд░рдорд╛рдЗрд▓реЛ рд╡рд╛рддрд╛рд╡рд░рдг рд░рд╣рдиреЗрдЫред"},
    {"sign":"рдХреБрдореНрдн","prediction":"рдирдпрд╛рдБ рдЕрд╡рд╕рд░рд╣рд░реВ рд╣рд╛рдд рд▓рд╛рдЧреНрдиреЗрдЫрдиреНред рд╡реНрдпрд╛рдкрд╛рд░ рд╡реНрдпрд╡рд╕рд╛рдпрдорд╛ рд░рд╛рдореНрд░реЛ рдкреНрд░рдЧрддрд┐ рд╣реБрдиреЗрдЫред"},
    {"sign":"рдореАрди","prediction":"рдорд╛рдирд╕рд┐рдХ рд╢рд╛рдиреНрддрд┐ рдорд┐рд▓реНрдиреЗрдЫред рдкрд░реЛрдкрдХрд╛рд░реА рдХрд╛рдордорд╛ рд╕рд╣рднрд╛рдЧреА рднрдЗрдиреЗрдЫред"}
];

app.get('/api/rasifal', async (req, res) => {
    try {
        console.log(`ЁЯдЦ Groq AI (${GROQ_MODEL}) рдкреНрд░рдпреЛрдЧ рдЧрд░реЗрд░ резреи рд░рд╛рд╢рд┐рдХреЛ рд░рд╛рд╢рд┐рдлрд▓ рддрдпрд╛рд░ рдкрд╛рд░рд┐рдБрджреИрдЫ...`);
        
        // рей. Groq API рдорд╛рд░реНрдлрдд рдбреЗрдЯрд╛ рддрд╛рдиреНрдиреЗ (резрежреж% рдлреНрд░реА)
        const response = await axios.post(
            'https://api.groq.com/openai/v1/chat/completions',
            {
                model: GROQ_MODEL, 
                messages: [{
                    role: "user",
                    content: `рддрдкрд╛рдИрдВ рдПрдХ рдЕрдиреБрднрд╡реА рдЬреНрдпреЛрддрд┐рд╖реА рд╣реБрдиреБрд╣реБрдиреНрдЫред рдЖрдЬрдХреЛ рдорд┐рддрд┐рдХреЛ рд▓рд╛рдЧрд┐ рдореЗрд╖ рджреЗрдЦрд┐ рдореАрди рд╕рдореНрдордХрд╛ резреи рд╡рдЯреИ рд░рд╛рд╢рд┐рдХреЛ рджреИрдирд┐рдХ рд░рд╛рд╢рд┐рдлрд▓ рдПрдХрджрдо рд╕рд░рд▓ рдиреЗрдкрд╛рд▓реА рднрд╛рд╖рд╛рдорд╛ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реНред
                    - рдЬрд╡рд╛рдл рдХреЗрд╡рд▓ JSON Array рдорд╛ рд╣реБрдиреБрдкрд░реНрдЫ: [{"sign": "рдореЗрд╖", "prediction": "..."}, ...]
                    - резреи рд╡рдЯреИ рд░рд╛рд╢рд┐ рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реБрдиреБрдкрд░реНрдЫред
                    - рдХреБрдиреИ рдкрдирд┐ рдЕрддрд┐рд░рд┐рдХреНрдд рдЯреЗрдХреНрд╕реНрдЯ рд╡рд╛ рдмреНрд░реНрдпрд╛рдХреЗрдЯ рдирд░рд╛рдЦреНрдиреБрд╣реЛрд╕реНред`
                }],
                // рдПрдЖрдИрд▓рд╛рдИ рд╕рд┐рдзреИ JSON рдорд╛рддреНрд░ рджрд┐рди рдмрд╛рдзреНрдп рдкрд╛рд░реНрдиреЗ рд╕реЗрдЯрд┐рдЩ
                response_format: { type: "json_object" }
            },
            {
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                timeout: 10000 // резреж рд╕реЗрдХреЗрдиреНрдбрдХреЛ рдЯрд╛рдЗрдордЖрдЙрдЯ
            }
        );

        // рек. рдкреНрд░рд╛рдкреНрдд рдбреЗрдЯрд╛рд▓рд╛рдИ рдкреНрд░реЛрд╕реЗрд╕ рдЧрд░реНрдиреЗ
        let content = response.data.choices[0].message.content;
        let aiData = JSON.parse(content);

        // рдПрдЖрдИрд▓реЗ рдХреБрди 'Key' рдорд╛ рдбреЗрдЯрд╛ рд░рд╛рдЦреНрдпреЛ рднрдиреЗрд░ рдЪреЗрдХ рдЧрд░реНрдиреЗ
        const finalData = Array.isArray(aiData) ? aiData : (aiData.horoscopes || aiData.data || aiData.rasifal || Object.values(aiData)[0]);

        res.json({
            status: "SUCCESS",
            source: "GROQ_FREE_AI",
            updatedAt: new Date().toISOString().split('T')[0],
            data: finalData
        });

    } catch (e) {
        console.error("тЪая╕П AI Failed! Error:", e.message);
        
        // рел. рдПрдЖрдИ рдлреЗрд▓ рднрдпреЛ рднрдиреЗ 'Fallback': рд╕реНрдЯреНрдпрд╛рдЯрд┐рдХ рдмреНрдпрд╛рдХрдЕрдк рдбреЗрдЯрд╛ рдкрдард╛рдЙрдиреЗ
        res.json({
            status: "SUCCESS",
            source: "STATIC_BACKUP_SAFE_MODE",
            updatedAt: new Date().toISOString().split('T')[0],
            data: backupRasifal
        });
    }
});

// рд╣реЛрдордкреЗрдЬ
app.get('/', (req, res) => res.send('Static Hybrid AI Rasifal Server is Online! ЁЯЪА'));

app.listen(PORT, () => console.log(`ЁЯЪА Server running on port ${PORT}`));
