const express = require('express');
const axios = require('axios');
require('dotenv').config();

const app = express();
// Render рдХреЛ рдкреЛрд░реНрдЯ резрежрежрежреж рд╕реЗрдЯ рдЧрд░рд┐рдПрдХреЛ рдЫ
const PORT = process.env.PORT || 10000; 

// рез. Render рдмрд╛рдЯ 'Dynamic' рдореЛрдбрд▓ рд░ рд╕рд╛рдБрдЪреЛ рддрд╛рдиреНрдиреЗ
// рдзреНрдпрд╛рди рджрд┐рдиреБрд╣реЛрд╕реН: Render рдорд╛ KEY рдХреЛ рдирд╛рдо 'GROQ_API_KEY' рд╣реБрдиреБрдкрд░реНрдЫ
const GROQ_API_KEY = process.env.GROQ_API_KEY || "";
const GROQ_MODEL = process.env.GROQ_MODEL || "llama-3.1-70b-versatile"; 

// реи. рд╕реНрдЯреНрдпрд╛рдЯрд┐рдХ рдмреНрдпрд╛рдХрдЕрдк рдбрд╛рдЯрд╛ (рдПрдЖрдИ рдлреЗрд▓ рднрдПрдХреЛ рдЦрдгреНрдбрдорд╛ рдпреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдкрдорд╛ рдЬрд╛рдиреНрдЫ)
const backupRasifal = [
    {"sign":"рдореЗрд╖","prediction":"рдЖрдЬ рдирдпрд╛рдБ рдХрд╛рдордХреЛ рдерд╛рд▓рдиреА рдЧрд░реНрдиреЗ рд░рд╛рдореНрд░реЛ рд╕рдордп рдЫред рдЖрддреНрдорд╡рд┐рд╢реНрд╡рд╛рд╕ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рд╡реГрд╖","prediction":"рдзрди рд░ рдкрд░рд┐рд╡рд╛рд░рдХреЛ рдХреНрд╖реЗрддреНрд░рдорд╛ рд▓рд╛рдн рдорд┐рд▓реНрдиреЗрдЫред рдмреЛрд▓реАрдорд╛ рдорд┐рдард╛рд╕ рд▓реНрдпрд╛рдЙрдиреБрд╣реЛрд▓рд╛ред"},
    {"sign":"рдорд┐рдереБрди","prediction":"рд▓рд╛рдореЛ рд╕рдордпрджреЗрдЦрд┐ рд░реЛрдХрд┐рдПрдХрд╛ рдХрд╛рдорд╣рд░реВ рдмрдиреНрдиреЗрдЫрдиреНред рд╕рд╛рдереАрдХреЛ рд╕рд╣рдпреЛрдЧ рдорд┐рд▓реНрдиреЗрдЫред"},
    {"sign":"рдХрд░реНрдХрдЯ","prediction":"рд╕реНрд╡рд╛рд╕реНрдереНрдпрдорд╛ рдЕрд▓рд┐ рдмрдвреА рдзреНрдпрд╛рди рджрд┐рдиреБрд╣реЛрд▓рд╛ред рдЕрдирд╛рд╡рд╢реНрдпрдХ рдЦрд░реНрдЪ рдмрдвреНрди рд╕рдХреНрдЫред"},
    {"sign":"рд╕рд┐рдВрд╣","prediction":"рдорд╛рди-рд╕рдореНрдорд╛рди рд░ рдкреНрд░рддрд┐рд╖реНрдард╛рдорд╛ рд╡реГрджреНрдзрд┐ рд╣реБрдиреЗрдЫред рд╕рд╛рдорд╛рдЬрд┐рдХ рдХрд╛рдордорд╛ рд░реБрдЪрд┐ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рдХрдиреНрдпрд╛","prediction":"рдЕрдзреНрдпрдпрди рдЕрдзреНрдпрд╛рдкрдирдорд╛ рд╕рдлрд▓рддрд╛ рдорд┐рд▓реНрдиреЗрдЫред рд╡реИрджреЗрд╢рд┐рдХ рдХрд╛рд░реНрдп рдЕрдШрд┐ рдмрдвреНрдиреЗрдЫред"},
    {"sign":"рддреБрд▓рд╛","prediction":"рдЖрд░реНрдерд┐рдХ рд▓рд╛рднрдХреЛ рдпреЛрдЧ рдЫред рдирдпрд╛рдБ рд╕рдореНрдмрдиреНрдзрд╣рд░реВ рд╕реБрдордзреБрд░ рд╣реБрдиреЗрдЫрдиреНред"},
    {"sign":"рд╡реГрд╢реНрдЪрд┐рдХ","prediction":"рдХрд╛рдордорд╛ рдврд┐рд▓рд╛рд╕реБрд╕реНрддреА рд╣реБрди рд╕рдХреНрдЫ, рдзреИрд░реНрдп рд░рд╛рдЦреНрдиреБрд╣реЛрд▓рд╛ред рд╢рддреНрд░реБ рдкрд░рд╛рд╕реНрдд рд╣реБрдиреЗрдЫрдиреНред"},
    {"sign":"рдзрдиреБ","prediction":"рдпрд╛рддреНрд░рд╛рдХреЛ рдпреЛрдЬрдирд╛ рдмрдиреНрдиреЗрдЫред рдзрд╛рд░реНрдорд┐рдХ рдХрд╛рд░реНрдпрдорд╛ рдорди рдЬрд╛рдиреЗрдЫред"},
    {"sign":"рдордХрд░","prediction":"рд░реЛрдХрд┐рдПрдХрд╛ рдкреБрд░рд╛рдирд╛ рдХрд╛рдорд╣рд░реВ рд╕реБрд▓реНрдЭрд┐рдиреЗрдЫрдиреНред рдШрд░рдорд╛ рд░рдорд╛рдЗрд▓реЛ рд╡рд╛рддрд╛рд╡рд░рдг рд░рд╣рдиреЗрдЫред"},
    {"sign":"рдХреБрдореНрдн","prediction":"рдирдпрд╛рдБ рдЕрд╡рд╕рд░рд╣рд░реВ рд╣рд╛рдд рд▓рд╛рдЧреНрдиреЗрдЫрдиреНред рд╡реНрдпрд╛рдкрд╛рд░ рд╡реНрдпрд╡рд╕рд╛рдпрдорд╛ рд░рд╛рдореНрд░реЛ рдкреНрд░рдЧрддрд┐ рд╣реБрдиреЗрдЫред"},
    {"sign":"рдореАрди","prediction":"рдорд╛рдирд╕рд┐рдХ рд╢рд╛рдиреНрддрд┐ рдорд┐рд▓реНрдиреЗрдЫред рдкрд░реЛрдкрдХрд╛рд░реА рдХрд╛рдордорд╛ рд╕рд╣рднрд╛рдЧреА рднрдЗрдиреЗрдЫред"}
];

app.get('/api/rasifal', async (req, res) => {
    try {
        console.log(`ЁЯдЦ Groq AI (${GROQ_MODEL}) рд▓рд╛рдИ рдЕрдиреБрд░реЛрдз рдкрдард╛рдЗрдБрджреИрдЫ...`);
        
        // рей. Groq API рдЕрдиреБрд░реЛрдз (JSON рд╕рдВрд░рдЪрдирд╛рдорд╛ рд╕реБрдзрд╛рд░ рдЧрд░рд┐рдПрдХреЛ)
        const response = await axios.post(
            'https://api.groq.com/openai/v1/chat/completions',
            {
                model: GROQ_MODEL,
                messages: [{
                    role: "user",
                    content: "рдЖрдЬрдХреЛ резреи рд░рд╛рд╢рд┐рдХреЛ рд░рд╛рд╢рд┐рдлрд▓ рд╕рд░рд▓ рдиреЗрдкрд╛рд▓реАрдорд╛ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реНред рдЬрд╡рд╛рдл рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реВрдкрдорд╛ рдпреЛ JSON рдврд╛рдБрдЪрд╛рдорд╛ рд╣реБрдиреБрдкрд░реНрдЫ: { \"data\": [ {\"sign\": \"рдореЗрд╖\", \"prediction\": \"...\"}, ... ] }"
                }],
                response_format: { type: "json_object" }
            },
            {
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                timeout: 15000 
            }
        );

        // рек. рдПрдЖрдИрдХреЛ рдЙрддреНрддрд░рд▓рд╛рдИ JSON рдорд╛ рдмрджрд▓реНрдиреЗ
        const aiResponse = JSON.parse(response.data.choices[0].message.content);
        const finalData = aiResponse.data || aiResponse.rasifal || aiResponse;

        res.json({
            status: "SUCCESS",
            source: "GROQ_FREE_AI",
            updatedAt: new Date().toISOString().split('T')[0],
            data: finalData
        });

    } catch (e) {
        // рел. рдПрдЖрдИ рдлреЗрд▓ рднрдпреЛ рднрдиреЗ 'Fallback': рдмреНрдпрд╛рдХрдЕрдк рдбрд╛рдЯрд╛ рдкрдард╛рдЙрдиреЗ
        console.error("тЪая╕П AI Failed! Error Code:", e.response ? e.response.status : e.message);
        
        res.json({
            status: "SUCCESS",
            source: "STATIC_BACKUP_SAFE_MODE",
            updatedAt: new Date().toISOString().split('T')[0],
            data: backupRasifal
        });
    }
});

app.get('/', (req, res) => res.send('AI Rasifal Server is Online and Secure! ЁЯЪА'));

app.listen(PORT, () => console.log(`ЁЯЪА Server running on port ${PORT}`));
